package twolovers.exploitfixer.bukkit.modules;

import com.comphenix.protocol.events.PacketEvent;
import io.netty.buffer.ByteBuf;
import org.bukkit.configuration.ConfigurationSection;
import org.bukkit.configuration.file.YamlConfiguration;
import org.bukkit.entity.Player;
import org.bukkit.plugin.Plugin;
import twolovers.exploitfixer.interfaces.instanceables.ExploitPlayer;
import twolovers.exploitfixer.interfaces.managers.ModuleManager;
import twolovers.exploitfixer.interfaces.modules.PacketsModule;
import twolovers.exploitfixer.shared.enums.Identity;
import twolovers.exploitfixer.shared.instanceables.Punishment;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

public class BukkitPacketsModule implements PacketsModule {
	private final Plugin plugin;
	private final ModuleManager moduleManager;
	private final Map<Identity, Integer> limits = new HashMap<>();
	private Punishment punishment;
	private boolean enabled;
	private int maxSize;
	private final boolean isOneDotSeven;

	public BukkitPacketsModule(final Plugin plugin, final ModuleManager moduleManager, final Object configYml) {
		this.plugin = plugin;
		this.moduleManager = moduleManager;
		reload(configYml);
		this.isOneDotSeven = plugin.getServer().getVersion().contains("1.7");
	}

	final public void reload(final Object configYml) {
		final YamlConfiguration configYml1 = (YamlConfiguration) configYml;
		final ConfigurationSection configurationSection = configYml1.getConfigurationSection("packets.limits");

		this.punishment = new Punishment(configYml1.getBoolean("packets.punishment.enabled"), configYml1.getBoolean("packets.punishment.kick"), configYml1.getInt("packets.punishment.threshold"), configYml1.getStringList("packets.punishment.commands"));
		this.enabled = configYml1.getBoolean("packets.enabled");
		this.maxSize = configYml1.getInt("packets.max_size");

		for (final String packetIdentityName : configurationSection.getKeys(false)) {
			for (final Identity identity : Identity.values()) {
				if (identity.name().equalsIgnoreCase(packetIdentityName)) {
					final Object value = configurationSection.get(packetIdentityName);

					if (value instanceof Integer)
						addLimit(identity, (Integer) value);

					break;
				}
			}
		}
	}

	public void addLimit(final Identity packet, final int value) {
		this.limits.put(packet, value);
	}

	public int getLimit(final Identity packet) {
		return limits.getOrDefault(packet, 10000);
	}

	public boolean isEnabled() {
		return enabled;
	}

	public void checkPacket(Object packetEvent, Identity identity) {
		if (enabled && packetEvent instanceof PacketEvent) {
			final PacketEvent event = (PacketEvent) packetEvent;

			if (!event.isCancelled()) {
				final Player player = event.getPlayer();
				int size = 1;
				final List<Object> values = event.getPacket().getModifier().getValues();

				if (values.size() > 1) {
					final Object object = values.get(1);

					if (!isOneDotSeven && object instanceof ByteBuf)
						size = ((ByteBuf) object).capacity();
				}

				if (player != null) {
					final String playerName = player.getName();
					final ExploitPlayer exploitPlayer = moduleManager.getExploitPlayerManager().getPlayer(playerName);

					if (exploitPlayer != null) {
						final int limit = getLimit(identity);

						if (size > maxSize) {
							exploitPlayer.punish(plugin, this, player);
							moduleManager.getNotificationsModule().sendNotification("PACKET_SIZE", player);
							event.setCancelled(true);
						} else if (limit > 0) {
							exploitPlayer.addViolation(identity);

							final int violations = exploitPlayer.getViolations(identity);

							if (violations == limit) {
								exploitPlayer.punish(plugin, this, player);
								moduleManager.getNotificationsModule().sendNotification(identity.name(), player);
								event.setCancelled(true);
							} else if (violations > limit)
								event.setCancelled(true);
						}
					}
				}
			}
		}
	}

	public String getName() {
		return "Packets";
	}

	public Punishment getPunishment() {
		return punishment;
	}
}
